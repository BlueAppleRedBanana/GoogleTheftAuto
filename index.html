<!DOCTYPE html>
<html>
<head>
    <title>Google Thief Auto</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script src="lib/jquery-1.11.1.min.js"></script>
<script src="lib/three.min.js"></script>
<script src="lib/osm2geo.js"></script>
<script src="map.js"></script>
<script src="collision.js"></script>
<script>
    var waitingAjax = false;
    var BBOX_SIZE = 0.001;
    var THRESHOLD = 0.0004;
    var currentMap;
    var maps = [];
    var container, camera, scene, renderer, car;

    var eachMap = [];

    var leftkey = false,
        rightkey = false,
        upkey = false,
        downkey = false,
        zoominkey = false,
        zoomoutkey = false;

    var stop = false;

    var visibleCar = !false,
        visibleBuilding = !false,
        visibleBound = !false,
        visibleSectionBound = !false;

    $(document).ready(function(){

        init();

        function init() {
            container = document.createElement( 'div' );
            document.body.appendChild( container );
            camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 0.000001, 0.003 );
            scene = new THREE.Scene();

            scene.add( new THREE.AmbientLight( 0xcccccc ) );

            var directionalLight = new THREE.DirectionalLight(/*Math.random() * 0xffffff*/0xeeeeee );
            directionalLight.position.x = Math.random() - 0.5;
            directionalLight.position.y = Math.random() - 0.5;
            directionalLight.position.z = Math.random() - 0.5;
            directionalLight.position.normalize();
            scene.add(directionalLight);

            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.setClearColorHex( 0xffffff, 1 );
            container.appendChild( renderer.domElement );

            window.addEventListener( 'resize', onWindowResize, false );
            
            var initMap = new Map(-74.0059,40.7120);
            maps[-74.0059]=[];
            maps[-74.0059][40.7120] = initMap;
            currentMap = initMap;
            eachMap.push(initMap);

            $(document).keydown(function(e){
                if(e.keyCode == 82){
                    zoominkey = true;
                }else if(e.keyCode == 84){
                    zoomoutkey = true;
                }else if(e.keyCode == 65 || e.keyCode == 37){
                    leftkey = true;
                }else if(e.keyCode == 68 || e.keyCode == 39){
                    rightkey = true;
                }else if(e.keyCode == 87 || e.keyCode == 38){
                    upkey = true;
                }else if(e.keyCode == 83 || e.keyCode == 40){
                    downkey = true;        
                }
                return false;
            });

            $(document).keyup(function(e){
//                console.log(e.keyCode);
                if(e.keyCode == 82){
                    zoominkey = false;
                }else if(e.keyCode == 84){
                    zoomoutkey = false;
                }else if(e.keyCode == 32){
                    stop = !stop;
                }else if(e.keyCode == 49){
                    visibleCar = !visibleCar;
                }else if(e.keyCode == 50){
                    visibleBuilding = !visibleBuilding;
                }else if(e.keyCode == 51){
                    visibleBound = !visibleBound;
                }else if(e.keyCode == 52){
                    visibleSectionBound = !visibleSectionBound;
                }else if(e.keyCode == 65 || e.keyCode == 37){
                    leftkey = false;
                }else if(e.keyCode == 68 || e.keyCode == 39){
                    rightkey = false;
                }else if(e.keyCode == 87 || e.keyCode == 38){
                    upkey = false;
                }else if(e.keyCode == 83 || e.keyCode == 40){
                    downkey = false;        
                }
                return false;
            });

//            animate();
        }

        function onWindowResize() {
            windowHalfX = window.innerWidth / 2;
            windowHalfY = window.innerHeight / 2;

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );
        }
    });

    function animate() {
        render();/*
        collisions = detectCollision();
        var buildings = currentMap.buildings;
        $.each(buildings, function(index, object) {
            object.material.color.setHex(0xE6E1B5);
        })
        $.each(collisions, function(index, object) {
            object.material.color.setHex(0xD6D1A5);
        })*/
        requestAnimationFrame( animate );
    }

    function updateCarVertices() {
        // TODO
    }
    
    function render() {
        if(!stop){
            if(leftkey){
              if(car.steering<0.05){ car.steering += 0.0004; }
            }else if(rightkey){
              if(car.steering>-0.05){  car.steering -= 0.0004; }
            }else{
              car.steering *= 0.1;
            }

            if(upkey){
              car.power = .00004;
            }else if(downkey){
              car.power = -.00004;
            }else{
              car.power = 0;
            }

            if(car.speed + car.power){
              car.speed += car.power;
            }

            car.direction += car.steering;

            car.position.x += car.speed * Math.cos(car.direction) * 0.001;
            car.position.y += car.speed * Math.sin(car.direction) * 0.001;
            car.speed *=0.99;

            car.rotation.z = car.direction;
            camera.position.x = car.position.x;
            camera.position.z = 0.0003+Math.abs(car.speed)/5;
            camera.position.y = car.position.y;
            camera.lookAt(car.position);

            if(typeof maps[currentMap.longitude+BBOX_SIZE] == "undefined"){
                    maps[currentMap.longitude+BBOX_SIZE]=[];
            }
            if(typeof maps[currentMap.longitude-BBOX_SIZE] == "undefined"){
                    maps[currentMap.longitude-BBOX_SIZE]=[];
            }
            if(car.position.x < currentMap.bbox.west+THRESHOLD && typeof maps[currentMap.longitude-BBOX_SIZE][currentMap.latitude] == "undefined"){
                var map = new Map(currentMap.longitude-BBOX_SIZE, currentMap.latitude);
                maps[currentMap.longitude-BBOX_SIZE][currentMap.latitude] = map;
                eachMap.push(map);
            }

            if(car.position.x > currentMap.bbox.east-THRESHOLD && typeof maps[currentMap.longitude+BBOX_SIZE][currentMap.latitude] == "undefined"){
                var map = new Map(currentMap.longitude+BBOX_SIZE, currentMap.latitude);
                maps[currentMap.longitude+BBOX_SIZE][currentMap.latitude] = map;
                eachMap.push(map);
            }

            if(car.position.y < currentMap.bbox.south+THRESHOLD && typeof maps[currentMap.longitude][currentMap.latitude-BBOX_SIZE] == "undefined"){
                var map = new Map(currentMap.longitude, currentMap.latitude-BBOX_SIZE);
                maps[currentMap.longitude][currentMap.latitude-BBOX_SIZE] = map;
                eachMap.push(map);
            }

            if(car.position.y > currentMap.bbox.north-THRESHOLD && typeof maps[currentMap.longitude][currentMap.latitude+BBOX_SIZE] == "undefined"){
                var map = new Map(currentMap.longitude, currentMap.latitude+BBOX_SIZE);
                maps[currentMap.longitude][currentMap.latitude+BBOX_SIZE] = map;
                eachMap.push(map);
            }

            car.visible = visibleCar;
            //console.log(car.position);
            $.each(eachMap, function(index1, value1){
                if( currentMap != value1 &&
                    car.position.x < value1.bbox.east &&
                    car.position.x > value1.bbox.west &&
                    car.position.y < value1.bbox.north &&
                    car.position.y > value1.bbox.south ){
                    currentMap = value1;
//                        console.log("moved");
                }
                if(value1.section)
                    value1.section.visible = visibleSectionBound;

                $.each(value1.buildings, function(index, value){
                    if(value.visible == visibleBuilding) return false;
                    value.visible = visibleBuilding;
                });
                $.each(value1.bounds, function(index, value){
                    if(value.visible == visibleBound) return false;
                    value.visible = visibleBound;
                });
            });

            renderer.render( scene, camera );
        }else{
            if(leftkey){
                camera.position.x-=0.0001;
            }else if(rightkey){
                camera.position.x+=0.0001;
            }

            if(downkey){
                camera.position.y-=0.0001;
            }else if(upkey){
                camera.position.y+=0.0001;
            }

            if(zoominkey){
                camera.position.z+=0.0001;
            }else if(zoomoutkey){
                camera.position.z-=0.0001;
            }
            
            var pos = camera.position.clone();
            pos.z=0;
            camera.lookAt(pos);
            renderer.render( scene, camera );
        }
    }
</script>
</head>
<body>

    <div id="data"></div>

</body>
</html>
