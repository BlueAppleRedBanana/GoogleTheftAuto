<!DOCTYPE html>
<html>
<head>
    <title>Google Thief Auto</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script src="lib/jquery-1.11.1.min.js"></script>
<script src="lib/three.min.js"></script>
<script src="lib/osm2geo.js"></script>
<script src="map.js"></script>
<script src="collision.js"></script>
<script>
    google.load('earth','1',{'other_params':"sensor={false}"});
</script>
<style>
    #map3d{
        position:absolute;
        width:100%;
        visibility:hidden;
    }
    .container{
        position:absolute;
        top:0px;
        width:100%;
        text-align:center;
    }
    .container canvas{
        border: 1px solid black;
    }

    .minimap{
        position: fixed;
        right:0px;
        top:0px;
    }
</style>
<script>
    var ge;
    var gecamera;
    var loc;
    var model;


    var waitingAjax = false;
    var BBOX_SIZE = 0.001;
    var THRESHOLD = 0.0004;
    var currentMap;
    var maps = [];
    var container, camera, scene, renderer, car;

    var eachMap = [];

    var leftkey = false,
        rightkey = false,
        upkey = false,
        downkey = false,
        zoominkey = false,
        zoomoutkey = false,
        minimapTogglekey = false;

    var stop = false;

    var visibleCar = !false,
        visibleBuilding = !false,
        visibleBound = !false,
        visibleSectionBound = !false;

    $(document).ready(function(){

        init();

        function init() {
            google.earth.createInstance("map3d",initCB, failureCB);

            container = document.createElement( 'div' );
            document.body.appendChild( container );
            $(container).addClass("container");
            camera = new THREE.PerspectiveCamera( 50, 1, 0.000001, 0.003 );
            scene = new THREE.Scene();

            scene.add( new THREE.AmbientLight( 0xcccccc ) );

            var directionalLight = new THREE.DirectionalLight(/*Math.random() * 0xffffff*/0xeeeeee );
            directionalLight.position.x = Math.random() - 0.5;
            directionalLight.position.y = Math.random() - 0.5;
            directionalLight.position.z = Math.random() - 0.5;
            directionalLight.position.normalize();
            scene.add(directionalLight);

            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize( window.innerHeight, window.innerHeight );
            renderer.setClearColorHex( 0xffffff, 1 );
            container.appendChild( renderer.domElement );
            
            var initMap = new Map(-74.0059,40.7120);
            maps[-74.0059]=[];
            maps[-74.0059][40.7120] = initMap;
            currentMap = initMap;
            eachMap.push(initMap);

            $(document).keydown(function(e){
                if(e.keyCode == 82){
                    zoominkey = true;
                }else if(e.keyCode == 84){
                    zoomoutkey = true;
                }else if(e.keyCode == 65 || e.keyCode == 37){
                    leftkey = true;
                }else if(e.keyCode == 68 || e.keyCode == 39){
                    rightkey = true;
                }else if(e.keyCode == 87 || e.keyCode == 38){
                    upkey = true;
                }else if(e.keyCode == 83 || e.keyCode == 40){
                    downkey = true;        
                }
                return false;
            });

            $(document).keyup(function(e){
                if(e.keyCode == 77){
                    minimapTogglekey = !minimapTogglekey;
                    if(minimapTogglekey){
                        $(".container canvas").addClass("minimap");
                        renderer.setSize( 160, 160 );
                        $("#map3d").css("visibility","visible");
                    }else{
                        $(".container canvas").removeClass("minimap");                        
                        $("#map3d").css("visibility","hidden");
                        renderer.setSize( window.innerHeight, window.innerHeight );
                    }
                }else if(e.keyCode == 82){
                    zoominkey = false;
                }else if(e.keyCode == 84){
                    zoomoutkey = false;
                }else if(e.keyCode == 32){
                    stop = !stop;
                }else if(e.keyCode == 49){
                    visibleCar = !visibleCar;
                }else if(e.keyCode == 50){
                    visibleBuilding = !visibleBuilding;
                }else if(e.keyCode == 51){
                    visibleBound = !visibleBound;
                }else if(e.keyCode == 52){
                    visibleSectionBound = !visibleSectionBound;
                }else if(e.keyCode == 65 || e.keyCode == 37){
                    leftkey = false;
                }else if(e.keyCode == 68 || e.keyCode == 39){
                    rightkey = false;
                }else if(e.keyCode == 87 || e.keyCode == 38){
                    upkey = false;
                }else if(e.keyCode == 83 || e.keyCode == 40){
                    downkey = false;        
                }
                return false;
            });

//            animate();
        }

        function initCB(instance) {
            ge = instance;
            ge.getWindow().setVisibility(true);
            ge.getOptions().setStatusBarVisibility(false);
            ge.getNavigationControl().setVisibility(ge.VISIBILITY_HIDE);
            ge.getOptions().setFlyToSpeed(ge.SPEED_TELEPORT);
            ge.getLayerRoot().enableLayerById(ge.LAYER_BUILDINGS, 1);
            ge.getLayerRoot().enableLayerById(ge.LAYER_TREES, 1); 
            ge.getOptions().setMouseNavigationEnabled(0);
            setLocation(ge);
        }

        function setLocation(ge) {
//            google.earth.addEventListener(ge, "frameend", handleFrame);

//            car = new Car(40.7311, -73.9887, direction);

            var placemark = ge.createPlacemark('');
            placemark.setName('model');
            model = ge.createModel('');
            ge.getFeatures().appendChild(placemark);
            loc = ge.createLocation('');
            model.setLocation(loc);
            var link = ge.createLink('');

            // link.setHref('http://www.edwardrockhands.com/GoogleTheftAuto/models/'+
            //   'splotchy_box.dae');
            link.setHref('http://earth-api-samples.googlecode.com/svn/trunk/examples/' +
             'static/splotchy_box.dae');

            model.setLink(link);
            var scale = model.getScale();
            var n= .1;
            scale.setX(n);
            scale.setY(n);
            scale.setZ(n);
            var la = ge.getView().copyAsLookAt(ge.ALTITUDE_RELATIVE_TO_GROUND);
            
            loc.setLatitude(40.7120);
            loc.setLongitude(-74.0059);

            placemark.setGeometry(model);
            ge.getView().setAbstractView(la);
        }

        function failureCB(errorCode) {

        }

    });

    function animate() {
        render();/*
        collisions = detectCollision();
        var buildings = currentMap.buildings;
        $.each(buildings, function(index, object) {
            object.material.color.setHex(0xE6E1B5);
        })
        $.each(collisions, function(index, object) {
            object.material.color.setHex(0xD6D1A5);
        })*/
        requestAnimationFrame( animate );
    }

    function updateCarVertices() {
        // TODO
    }
    
    function render() {


        car.visible = visibleCar;

        $.each(eachMap, function(index1, value1){
            if( currentMap != value1 &&
                car.position.x < value1.bbox.east &&
                car.position.x > value1.bbox.west &&
                car.position.y < value1.bbox.north &&
                car.position.y > value1.bbox.south ){
                currentMap = value1;
            }
            if(value1.section){
                if(value1 == currentMap){
                    value1.section.material.color.setHex(0x007148);
                }else{
                    value1.section.material.color.setHex(0x8CBEB2);
                }                    
            }

            if(value1.section)
                value1.section.visible = visibleSectionBound;

            $.each(value1.buildings, function(index, value){
                if(value.visible == visibleBuilding) return false;
                value.visible = visibleBuilding;
            });
            $.each(value1.bounds, function(index, value){
                if(value.visible == visibleBound) return false;
                value.visible = visibleBound;
            });
        });

        if(!stop){
            if(leftkey){
              if(car.steering<0.05){ car.steering += 0.0004; }
            }else if(rightkey){
              if(car.steering>-0.05){  car.steering -= 0.0004; }
            }else{
              car.steering *= 0.1;
            }

            if(upkey){
              car.power = .00004;
            }else if(downkey){
              car.power = -.00004;
            }else{
              car.power = 0;
            }

            if(car.speed + car.power){
              car.speed += car.power;
            }

            car.direction += car.steering;

            car.position.x += car.speed * Math.cos(car.direction) * 0.001;
            car.position.y += car.speed * Math.sin(car.direction) * 0.001;
            car.speed *=0.99;

            car.rotation.z = car.direction;
            camera.position.x = car.position.x;
            camera.position.z = 0.0003+Math.abs(car.speed)/5;
            camera.position.y = car.position.y;
            camera.lookAt(car.position);

            // Goggle Earth
            if(loc){
                loc.setLatitude(car.position.y);
                loc.setLongitude(car.position.x);
                var orientation = model.getOrientation();
                orientation.setHeading(car.direction/Math.PI*180%360);
                model.setOrientation(orientation);                
            }

            var ca = ge.createCamera('');

            ca.setLongitude(car.position.x - 0.001*Math.cos(car.direction));
            ca.setLatitude(car.position.y - 0.001*Math.sin(car.direction));
            ca.setTilt(85);
            ca.setAltitude(20);
            ca.setHeading(360-car.direction/Math.PI*180%360);

            ge.getView().setAbstractView(ca);


            if(typeof maps[currentMap.longitude+BBOX_SIZE] == "undefined"){
                    maps[currentMap.longitude+BBOX_SIZE]=[];
            }
            if(typeof maps[currentMap.longitude-BBOX_SIZE] == "undefined"){
                    maps[currentMap.longitude-BBOX_SIZE]=[];
            }
            if(car.position.x < currentMap.bbox.west+THRESHOLD && typeof maps[currentMap.longitude-BBOX_SIZE][currentMap.latitude] == "undefined"){
                var map = new Map(currentMap.longitude-BBOX_SIZE, currentMap.latitude);
                maps[currentMap.longitude-BBOX_SIZE][currentMap.latitude] = map;
                eachMap.push(map);
            }

            if(car.position.x > currentMap.bbox.east-THRESHOLD && typeof maps[currentMap.longitude+BBOX_SIZE][currentMap.latitude] == "undefined"){
                var map = new Map(currentMap.longitude+BBOX_SIZE, currentMap.latitude);
                maps[currentMap.longitude+BBOX_SIZE][currentMap.latitude] = map;
                eachMap.push(map);
            }

            if(car.position.y < currentMap.bbox.south+THRESHOLD && typeof maps[currentMap.longitude][currentMap.latitude-BBOX_SIZE] == "undefined"){
                var map = new Map(currentMap.longitude, currentMap.latitude-BBOX_SIZE);
                maps[currentMap.longitude][currentMap.latitude-BBOX_SIZE] = map;
                eachMap.push(map);
            }

            if(car.position.y > currentMap.bbox.north-THRESHOLD && typeof maps[currentMap.longitude][currentMap.latitude+BBOX_SIZE] == "undefined"){
                var map = new Map(currentMap.longitude, currentMap.latitude+BBOX_SIZE);
                maps[currentMap.longitude][currentMap.latitude+BBOX_SIZE] = map;
                eachMap.push(map);
            }
            renderer.render( scene, camera );
        }else{
            if(leftkey){
                camera.position.x-=0.0001;
            }else if(rightkey){
                camera.position.x+=0.0001;
            }

            if(downkey){
                camera.position.y-=0.0001;
            }else if(upkey){
                camera.position.y+=0.0001;
            }

            if(zoominkey){
                camera.position.z+=0.0001;
            }else if(zoomoutkey){
                camera.position.z-=0.0001;
            }
            
            var pos = camera.position.clone();
            pos.z=0;
            camera.lookAt(pos);
            renderer.render( scene, camera );
        }
    }
</script>
</head>
<body>
<div id="map3d"></div>
</body>
</html>
